# Chatta with mbare
Chatta with mbare is a web chat and video call application, made with Angular and NodeJS, made as a university assignment for Web Programming, Design and Usability course.
## Application design
This application follows the client-server pattern, with NodeJS providing services such as websockets communications and message dispatching, and the client providing the interface the users would use to chat and videocall with their fellas;
furthermore, as I love the concept of actions provided by NgRx and Redux, I chose this concept both on client and server, the server has indeed a dispatcher of messages that works closely with the clients, the sessions listen to their inbound messages or public events, while they can dispatch other messages to other clients, but resulted in a nightmare 'cos I haven't provided a clear separation of server and client actions.
### Server design
The server uses SocketIO to provide both manageable websocket connections, expressjs to provide static resources such as the client and user pictures and a single real GET call to get a list of these pictures.
Each connection via websockets goes through the SessionManager, as the user provides its own uuid, it just checks if it is connected, if not create a new Session which proxies actions between the global server's dispatcher and the client itself, once the connection gets lost or closed, SessionManager disposes Session.
Server does not store any data shared between users.
### Client design
The client is made with Angular to provide a comfy development environment; the style is inspired by GNOME's borderless mocks.
It uses NgRx to provide states and side-effects, Dexie to store messages and known users so you can write to them even when not connected ( provided you both will be online at some point in order to send unsent messages ); SocketIO-client to bridge events from servers to client and viceversa; PeerJS handles streaming calls, sadly this would connect to their own server as it is incompatible with SocketIO in the backend.
### Issues encountered.
 1. This is the first time I make a video call application and didn't know where to start, it provided a challenge yet I got to know better websocket uses and could use this technology better in next projects.
 2. I first tried to use RxDB to provide storage, it is usually great with Angular, yet it is not performant and leaves somethign to desire in documentation, this time it was so frustating, I had to search for alternatives, Dexie was found, albeit it does not have live queries, it is a nice abstraction over IndexedDB.
 3. Mobile devices have incorrect viewport units, ALL OF THEM, 'cos they do not take in account their navigation bar, ~~this trick saved the day: https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ .~~
 4. I made an unnecessary large project, as I could easily follow a PeerJS+SocketIO tutorial and get away with it.
 5. PeerJS and SocketIO do not like each other, you cannot have both of them in the same port, so I used peerjs' public endpoint.
 6. Angular does not update UI if source's not gone through NgZone, made a proxy pipe for under client's `src/utils` to solve this. Actually, almost all observables instantiated through an angular component or service are tracked by NgZone, but the ones instantiated outside of angular's exclusive zone are not, so the custom pipe comes in, `zoneePipe` takes the component's\service's zone and uses it to proxy the source. 
 7. Call management is hell, I had rewritten it at least 6 times, 'cos you have you and your pal, sharing a stream and then one of you wants to stream their screen, so a new call must be made. As a side note, I found this by Mozilla https://blog.mozilla.org/webrtc/warm-up-with-replacetrack/ which helped a lot, TL;DR; you always start a complete stream with video+audio, but content is dummy, tracks are replaced as you request or unrequest mic or webcam use with dummy ones or viceversa.
 8. Angular lazy loading would not load a lazy's lazy child: one trick I used to make call and answer, is to guard both `/app/avchat/answer/:uuid` and `/app/avchat/call/:uuid` , when you try to call your pal, the client navigates to the latter, and fires the guard which waits for pal's answer, but pal's must be redirected by a session's event, and `router.navigate(['/app/avchat/answer',caller])` didn't work at all, so I thought I could redirect from `RootModule`'s router, which is parent of `CallModule`, to its child with a redirect like `redirect: 'url...'`, and then it worked.

# Build me plz
Git clone this repo, then by cli go under app and write  `npm i`, then `npm run build`, these commands will install some gigs of deps for angular and build the client under `server/static/client`, then change dir to server, run `npm i` again, then `node index` and you are good to go, server is hosted by default at `0.0.0.0:8080`.
You can use the environment variables `HTTP_PORT` and `HTTP_HOSTNAME` to change port and hostname respectively.